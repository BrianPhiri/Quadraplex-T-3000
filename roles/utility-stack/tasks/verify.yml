---
- name: Wait for services to be ready
  wait_for:
    port: "{{ item.port }}"
    host: "127.0.0.1"
    delay: 5
    timeout: 300
    msg: "{{ item.service }} service did not start within 5 minutes"
  loop:
    - { service: "Portainer", port: "{{ services.portainer.port }}" }
  when: services[item.service.lower().replace(' ', '_')].enabled | default(true)

- name: Check service health endpoints
  uri:
    url: "http://127.0.0.1:{{ item.port }}{{ item.health_path | default('') }}"
    method: GET
    status_code: [200, 302, 401] 
    timeout: 30
  register: health_check
  retries: 5
  delay: 10
  until: health_check.status in [200, 302, 401]
  loop:
    - { service: "Portainer", port: "{{ services.portainer.port }}", health_path: "/" }
  when: services[item.service.lower().replace(' ', '_')].enabled | default(true)

- name: Check Docker container status
  docker_container_info:
    name: "{{ item }}"
  register: container_status
  loop:
    - portainer
  when: services[item.replace('-', '_')].enabled | default(true)

- name: Verify containers are running
  assert:
    that:
      - item.exists
      - item.container.State.Status == "running"
      - item.container.State.Health.Status is undefined or item.container.State.Health.Status == "healthy"
    fail_msg: "Container {{ item.container.Name }} is not running properly"
    success_msg: "Container {{ item.container.Name }} is running and healthy"
  loop: "{{ container_status.results }}"
  when: item.item is defined and services[item.item.replace('-', '_')].enabled | default(true)

- name: Check Docker network connectivity
  command: docker exec {{ item.container }} ping -c 1 {{ item.target }}
  register: network_test
  changed_when: false
  failed_when: network_test.rc != 0
  loop:
    - { container: "portainer", target: "portainer" }
  when: 
    - services.portainer.enabled | default(true)

- name: Verify data directory permissions
  stat:
    path: "{{ utility_stack.data_path }}/{{ item }}"
  register: data_dir_stats
  loop:
    - portainer
  when: services[item.replace('-', '_')].enabled | default(true)

- name: Check data directory ownership
  assert:
    that:
      - data_dir_stats.results[index].stat.uid == utility_stack.user_id | int
      - data_dir_stats.results[index].stat.gid == utility_stack.group_id | int
    fail_msg: "Data directory {{ item }} has incorrect ownership"
  loop:
    - portainer
  loop_control:
    index_var: index
  when: 
    - services[item.replace('-', '_')].enabled | default(true)
    - data_dir_stats.results[index].stat.exists


- name: Check systemd service status
  systemd:
    name: utility-stack
    state: started
  register: systemd_status

- name: Verify systemd service is enabled
  command: systemctl is-enabled utility-stack
  register: systemd_enabled
  changed_when: false
  failed_when: systemd_enabled.stdout != "enabled"
