---
- name: Wait for services to be ready
  wait_for:
    port: "{{ item.port }}"
    host: "127.0.0.1"
    delay: 5
    timeout: 300
    msg: "{{ item.service }} service did not start within 5 minutes"
  loop:
    - { service: "Traefik", port: "{{ proxy_stack.services.traefik.http }}" }
  when: services[item.service.lower().replace(' ', '_')].enabled | default(true)

- name: Check Docker container status
  docker_container_info:
    name: "{{ item }}"
  register: container_status
  loop:
    - traefik
  when: services[item.replace('-', '_')].enabled | default(true)

- name: Verify containers are running
  assert:
    that:
      - item.exists
      - item.container.State.Status == "running"
      - item.container.State.Health.Status is undefined or item.container.State.Health.Status == "healthy"
    fail_msg: "Container {{ item.container.Name }} is not running properly"
    success_msg: "Container {{ item.container.Name }} is running and healthy"
  loop: "{{ container_status.results }}"
  when: item.item is defined and services[item.item.replace('-', '_')].enabled | default(true)

- name: Verify data directory permissions
  stat:
    path: "{{ proxy_stack.data_path }}/{{ item }}"
  register: data_dir_stats
  loop:
    - traefik
  when: services[item.replace('-', '_')].enabled | default(true)

- name: Check data directory ownership
  assert:
    that:
      - data_dir_stats.results[index].stat.uid == proxy_stack.user_id | int
      - data_dir_stats.results[index].stat.gid == proxy_stack.group_id | int
    fail_msg: "Data directory {{ item }} has incorrect ownership"
  loop:
    - traefik
  loop_control:
    index_var: index
  when: 
    - services[item.replace('-', '_')].enabled | default(true)
    - data_dir_stats.results[index].stat.exists

- name: Check systemd service status
  systemd:
    name: proxy-stack
    state: started
  register: systemd_status

- name: Verify systemd service is enabled
  command: systemctl is-enabled proxy-stack
  register: systemd_enabled
  changed_when: false
  failed_when: systemd_enabled.stdout != "enabled"
